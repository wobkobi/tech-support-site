// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

enum BookingStatus {
  held
  confirmed
  cancelled
  completed // NEW: Added for tracking completed appointments
}

enum ReviewStatus {
  pending
  approved
  revoked
}

model Booking {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Person booking the appointment.
  name  String
  email String
  notes String?

  // When the appointment actually runs (in server time / UTC).
  startUtc DateTime
  endUtc   DateTime

  // Per-booking buffer, in minutes, before and after the appointment.
  bufferBeforeMin Int @default(0)
  bufferAfterMin  Int @default(0)

  // Status and hold expiry for possible future multi-step flows.
  status         BookingStatus @default(confirmed)
  holdExpiresUtc DateTime?

  // Secret tokens for management links
  cancelToken String @unique
  reviewToken String @unique @default(uuid()) // NEW: Token for review link

  // Double-booking prevention: Unique constraint on active time slots
  // Set to startUtc.toISOString() when booking is active (held or confirmed)
  // Set to null (field omitted in MongoDB) when cancelled or expired; the sparse unique index
  // only enforces uniqueness for documents where activeSlotKey is present/non-null, so multiple
  // bookings can safely have activeSlotKey = null.
  activeSlotKey String? @unique

  // Optional reference to the Google Calendar event, for future cancellation.
  calendarEventId String?

  // Review tracking - NEW
  reviewSentAt      DateTime? // When review email was sent
  reviewSubmittedAt DateTime? // When they submitted a review

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startUtc, endUtc])
  @@index([status, holdExpiresUtc])
  @@index([calendarEventId])
}

model Review {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  text        String
  firstName   String?
  lastName    String?
  isAnonymous Boolean @default(false)

  // Moderation status
  status      ReviewStatus @default(pending)

  // For edit/auth (magic link, booking ref, etc)
  customerRef String?

  // NEW: Link to booking (optional, for verified reviews)
  bookingId String? @db.ObjectId
  verified  Boolean @default(false) // True if from a booking link

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Standalone review requests for past clients (email or SMS)
model ReviewRequest {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  reviewToken       String    @unique @default(uuid())
  reviewSubmittedAt DateTime?
  createdAt         DateTime  @default(now())
}

// Cached calendar events for fast booking page loads
model CalendarEventCache {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Event details from Google Calendar
  eventId       String   // Google Calendar event ID
  calendarEmail String   // Which calendar this event is from
  startUtc      DateTime // Event start time
  endUtc        DateTime // Event end time

  // Cache metadata
  fetchedAt DateTime @default(now()) // When this was cached
  expiresAt DateTime // When to refresh this cache entry

  @@index([expiresAt])
  @@index([startUtc, endUtc])
  @@unique([eventId, calendarEmail])
}
